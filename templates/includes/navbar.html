<div class="navbar">
    <div class="nav-brand">
        <img src="/static/etc/logo.png" alt='logo' class="nav-logo" id="siteLogo">
        <div class="nav-left" id="siteName">Rem Battle Simulator</div>
    </div>
    <div class="nav-buttons">
        {% if user %}
            <a href="/contract">
                <button>Контракты</button>
            </a>
            <a href="/upgrade">
                <button>Апгрейды</button>
            </a>
            <a href="/battle">
                <button>Баттлы</button>
            </a>
            <a href="/case/create">
                <button>Добавить кейс</button>
            </a>
        {% endif %}
        <a href="/top/">
            <button>Топ пользователей</button>
        </a>
        {% if user.is_admin %}
        <a href="/admin">
            <button>Админка</button>
        </a>
        {% endif %}
    </div>
    {% if user %}
    <div class="user-profile" id="userProfile">
        <a href="/chat/list" class="chat-button">
            <button class="notification-button" id="chatButton">
                <i class="fas fa-comments"></i>
                {% if new_messages_cnt > 0 %}
                    <span class="notification-badge">{{ new_messages_cnt }}</span>
                {% endif %}
            </button>
        </a>

        <button class="notification-button" id="notificationButton">
            <i class="fas fa-bell"></i>
            {% if notifications_cnt > 0 %}
                <span class="notification-badge">{{ notifications_cnt }}</span>
            {% endif %}
        </button>
        <a href="/user/profile" class="profile-link">
            <img src="/static/avatars/{{user.avatar}}"
                 alt="Аватар"
                 class="user-avatar"
                 onerror="this.onerror=null; this.src='https://via.placeholder.com/100'">
            <div class="user-info">
                <div class="user-username">{{user.username}}</div>
                <div class="user-balance">Баланс: {{user.balance}}</div>
            </div>
        </a>
        <button class="add-balance-button" id="toggleBalanceMenu">+</button>
        <div class="balance-menu" id="balanceMenu">
            <input type="number" id="amountInput" placeholder="Сумма пополнения" min="1" required>
            <button id="addMoneyBtn">Пополнить</button>
        </div>
        <form action="/user/logout" method="POST" class="logout-form">
            <button type="submit" class="logout-button">
                <i class="fas fa-sign-out-alt"></i> Выйти
            </button>
        </form>
    </div>
    {% else %}
    <div class="nav-buttons">
        <a href="/user/register"> <button>Зарегистрироваться</button> </a>
        <a href="/user/login"> <button>Войти</button> </a>
    </div>
    {% endif %}
</div>

<div id="notificationsOverlay" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(18,22,30,0.65); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:#23272e; border-radius:16px; max-width:500px; width:90vw; margin:0 auto; box-shadow:0 2px 24px #2979ff33; padding:32px 24px 24px 24px; position:relative; display:flex; flex-direction:column; align-items:center;">
        <span id="closeNotificationsOverlay" style="position:absolute; top:18px; right:24px; font-size:28px; color:#aaa; cursor:pointer;">&times;</span>
        <div style="font-size:22px; color:#aeeaff; font-weight:bold; margin-bottom:18px;">Уведомления</div>
        <ul id="notificationsList" style="list-style:none; padding:0; margin:0; width:100%; display:flex; flex-direction:column; gap:12px; max-height:60vh; overflow-y:auto;">
            {% for notification in notifications %}
            <li class="notification-item">
                <div class="notification-content">
                    <div class="notification-text">{{ notification.text }}</div>
                    <div class="notification-time">{{ notification.created.strftime('%d.%m.%Y %H:%M') }}</div>
                </div>
                {% if notification.type == 'request' %}
                {% set sender_username = notification.notification_sender.username %}
                <div class="notification-actions">
                    <form class="accept-form" data-username="{{ sender_username }}" method="POST">
                        <button type="submit" class="friend-btn accept">
                            <i class="fas fa-check"></i>
                        </button>
                    </form>
                    <form class="reject-form" data-username="{{ sender_username }}" method="POST">
                        <button type="submit" class="friend-btn reject">
                            <i class="fas fa-times"></i>
                        </button>
                    </form>
                </div>
                {% endif %}
            </li>
            {% else %}
            <li style="text-align:center; color:#777;">Нет уведомлений</li>
            {% endfor %}
        </ul>
    </div>
</div>

<style>
    .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #1e1e1e;
        padding: 15px 30px;
        border-bottom: 1px solid #333;
        position: sticky;
        top: 0;
        z-index: 1000;
    }
    .nav-brand {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .nav-logo {
        height: 40px;
        cursor: pointer;
    }
    .nav-left {
        font-size: 20px;
        font-weight: bold;
        color: #2979ff;
        cursor: pointer;
        text-decoration: none;
    }
    .nav-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        row-gap: 6px;
        max-width: 100vw;
    }
    .nav-buttons button {
        background-color: #2979ff;
        color: white;
        border: none;
        padding: clamp(4px, 1vw, 8px) clamp(6px, 1.5vw, 12px);
        font-size: clamp(10px, 2vw, 14px);
        border-radius: 4px;
        cursor: pointer;
        min-width: 80px;
        min-height: 40px;
        white-space: nowrap;
        transition: all 0.2s;
    }
    .nav-buttons button:hover {
        background-color: #1c54b2;
    }
    .user-profile {
        display: flex;
        align-items: center;
        gap: 15px;
        position: relative;
    }
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #2979ff;
        cursor: pointer;
    }
    .user-info {
        text-align: left;
        font-size: 14px;
    }
    .user-username {
        font-weight: bold;
    }
    .user-balance {
        color: #aeeaff;
        font-size: 12px;
    }
    .add-balance-button {
        background-color: #4caf50;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
        max-width: 32px;
        max-height: 32px;
        font-size: 20px;
        border-radius: 50%;
        cursor: pointer;
        margin-left: 10px;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    .add-balance-button:hover {
        background-color: #388e3c;
    }
    .balance-menu {
        position: absolute;
        top: 50px;
        right: 0;
        background-color: #2a2a2a;
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        width: 200px;
        display: none;
        flex-direction: column;
        gap: 10px;
        z-index: 1001;
    }
    .balance-menu input {
        padding: 8px;
        border: 1px solid #444;
        border-radius: 4px;
        background-color: #1e1e1e;
        color: #fff;
    }
    .balance-menu button {
        padding: 8px;
        background-color: #2979ff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .balance-menu button:hover {
        background-color: #1c54b2;
    }
    .notification-button {
        background: none;
        border: none;
        color: #fff;
        font-size: 20px;
        position: relative;
        margin-right: 10px;
        cursor: pointer;
    }
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #f44336;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .logout-form {
        margin-right: 15px;
    }
    .logout-button {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 8px 15px;
        font-size: 14px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background-color 0.3s;
    }
    .logout-button:hover {
        background-color: #d32f2f;
    }
    .logout-button i {
        font-size: 14px;
    }
    .profile-link {
        display: flex;
        align-items: center;
        gap: 15px;
        text-decoration: none;
        color: inherit;
        cursor: pointer;
    }
    .notification-item {
        background: #1e1e1e;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 8px;
        border-left: 3px solid #2979ff;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .notification-content {
        flex-grow: 1;
    }
    .notification-text {
        font-size: 14px;
        color: #ccc;
    }
    .notification-time {
        font-size: 12px;
        color: #777;
        margin-top: 5px;
    }
    .notification-actions {
        display: flex;
        gap: 8px;
        margin-left: 10px;
    }
    .friend-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #2979ff;
        color: #fff;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 16px;
    }
    .friend-btn.accept {
        background: #4CAF50;
    }
    .friend-btn.reject {
        background: #f44336;
    }
    .friend-btn.cancel {
        background: #f44336;
    }
    .friend-btn.delete {
        background: #f44336;
    }
    .friend-btn:hover {
        opacity: 0.9;
        transform: scale(1.05);
    }
    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border-radius: 4px;
        z-index: 10000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        opacity: 1;
        transition: opacity 0.3s ease;
    }
    .notification.error {
        background-color: #f44336;
    }
    .chat-button {
        display: inline-block;
        position: relative;
        margin-right: 10px;
    }
    .chat-button .notification-button {
        margin-right: 0;
    }
</style>

<script>
    document.getElementById("siteName").addEventListener("click", function() {
        window.location.href = "/";
    });
    document.getElementById("siteLogo").addEventListener("click", function() {
        window.location.href = "/";
    });

    function showNotification(message, isError = false) {
        const notification = document.createElement('div');
        notification.className = `notification ${isError ? 'error' : ''}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    const balanceMenu = document.getElementById("balanceMenu");
    const toggleBalanceBtn = document.getElementById("toggleBalanceMenu");
    const addMoneyBtn = document.getElementById("addMoneyBtn");
    const amountInput = document.getElementById("amountInput");

    if (toggleBalanceBtn && balanceMenu) {
        toggleBalanceBtn.addEventListener("click", function(event) {
            event.stopPropagation();
            balanceMenu.style.display = balanceMenu.style.display === "flex" ? "none" : "flex";
        });
    }

    document.addEventListener("click", function(event) {
        if (!event.target.closest('.user-profile')) {
            if (balanceMenu) balanceMenu.style.display = "none";
            if (notificationsOverlay) notificationsOverlay.style.display = "none";
        }
    });

    function parseMoney(value) {
        if (typeof value === 'number') return value;
        const cleaned = String(value).replace(/[^\d.,]/g, '').replace(',', '.');
        return parseFloat(cleaned) || 0;
    }

    function formatBalances() {
        document.querySelectorAll('.user-balance').forEach(el => {
            const text = el.textContent;
            const match = text.match(/([\d.,]+)$/);
            if (match) {
                const balanceValue = parseFloat(match[1].replace(',', '.'));
                el.textContent = text.replace(match[1], balanceValue.toFixed(2));
            }
        });
    }

    if (addMoneyBtn) {
        addMoneyBtn.addEventListener('click', async function() {
            const amount = parseMoney(amountInput.value);
            if (isNaN(amount) || amount <= 0) {
                showNotification('Введите корректную сумму', true);
                return;
            }
            try {
                const response = await fetch(`/user/add_money/${amount}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (response.ok) {
                    document.querySelectorAll('.user-balance').forEach(el => {
                        el.textContent = `Баланс: ${parseFloat(result.new_balance).toFixed(2)}`;
                    });
                    window.userBalance = parseFloat(result.new_balance);
                    const event = new CustomEvent('balanceUpdated', {
                        detail: { newBalance: window.userBalance }
                    });
                    window.dispatchEvent(event);
                    if (balanceMenu) balanceMenu.style.display = 'none';
                    if (amountInput) amountInput.value = '';
                    showNotification('Баланс успешно пополнен!');
                } else {
                    throw new Error(result.detail || 'Ошибка пополнения');
                }
            } catch (error) {
                showNotification(error.message, true);
            }
        });
    }

    const notificationButton = document.getElementById('notificationButton');
    const notificationsOverlay = document.getElementById('notificationsOverlay');
    const closeNotificationsBtn = document.getElementById('closeNotificationsOverlay');

    if (notificationButton) {
        notificationButton.addEventListener('click', async function() {
            if (notificationsOverlay) notificationsOverlay.style.display = 'flex';

            try {
                const response = await fetch('/notification/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const badge = document.querySelector('.notification-badge');
                    if (badge) badge.remove();
                }
            } catch (error) {
                console.error('Ошибка при отметке уведомлений:', error);
            }
        });
    }

    if (closeNotificationsBtn) {
        closeNotificationsBtn.addEventListener('click', function() {
            if (notificationsOverlay) notificationsOverlay.style.display = 'none';
        });
    }

    // Обработка принятия заявки в друзья
    document.querySelectorAll('.accept-form').forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = this.getAttribute('data-username');
            const button = this.querySelector('button');
            const originalHtml = button.innerHTML;

            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;

            try {
                const response = await fetch(`/user/accept/${encodeURIComponent(username)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                if (response.ok && result.status === 'ok') {
                    showNotification('Заявка принята!');
                    // Обновляем список уведомлений без перезагрузки страницы
                    loadNotifications();
                } else {
                    throw new Error(result.detail || 'Ошибка при принятии заявки');
                }
            } catch (error) {
                showNotification(error.message, true);
            } finally {
                button.innerHTML = originalHtml;
                button.disabled = false;
            }
        });
    });

    // Обработка отклонения заявки в друзья
    document.querySelectorAll('.reject-form').forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = this.getAttribute('data-username');
            const button = this.querySelector('button');
            const originalHtml = button.innerHTML;

            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;

            try {
                const response = await fetch(`/user/reject/${encodeURIComponent(username)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                if (response.ok && result.status === 'ok') {
                    showNotification('Заявка отклонена');
                    // Обновляем список уведомлений без перезагрузки страницы
                    loadNotifications();
                } else {
                    throw new Error(result.detail || 'Ошибка при отклонении заявки');
                }
            } catch (error) {
                showNotification(error.message, true);
            } finally {
                button.innerHTML = originalHtml;
                button.disabled = false;
            }
        });
    });

    // Функция для загрузки уведомлений
    async function loadNotifications() {
        try {
            const response = await fetch('/notification/list');
            if (response.ok) {
                const notifications = await response.json();
                updateNotificationsUI(notifications);
            }
        } catch (error) {
            console.error('Ошибка загрузки уведомлений:', error);
        }
    }

    // Функция для обновления UI уведомлений
    function updateNotificationsUI(notifications) {
        const notificationsList = document.getElementById('notificationsList');
        if (!notificationsList) return;

        notificationsList.innerHTML = '';

        if (notifications.length === 0) {
            notificationsList.innerHTML = '<li style="text-align:center; color:#777;">Нет уведомлений</li>';
            return;
        }

        notifications.forEach(notification => {
            const li = document.createElement('li');
            li.className = 'notification-item';
            li.innerHTML = `
                <div class="notification-content">
                    <div class="notification-text">${notification.text}</div>
                    <div class="notification-time">${notification.created}</div>
                </div>
                ${notification.type === 'request' ? `
                <div class="notification-actions">
                    <form class="accept-form" data-username="${notification.sender_username}" method="POST">
                        <button type="submit" class="friend-btn accept">
                            <i class="fas fa-check"></i>
                        </button>
                    </form>
                    <form class="reject-form" data-username="${notification.sender_username}" method="POST">
                        <button type="submit" class="friend-btn reject">
                            <i class="fas fa-times"></i>
                        </button>
                    </form>
                </div>
                ` : ''}
            `;
            notificationsList.appendChild(li);
        });

        // Добавляем обработчики событий для новых форм
        document.querySelectorAll('.accept-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = this.getAttribute('data-username');
                handleFriendAction('accept', username, this.querySelector('button'));
            });
        });

        document.querySelectorAll('.reject-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = this.getAttribute('data-username');
                handleFriendAction('reject', username, this.querySelector('button'));
            });
        });

        // Обновляем счетчик уведомлений
        const badge = document.querySelector('.notification-badge');
        if (badge) {
            const unreadCount = notifications.filter(n => !n.is_read).length;
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
            } else {
                badge.remove();
            }
        }
    }

    // Общая функция для обработки действий с друзьями
    async function handleFriendAction(action, username, button) {
        const originalHtml = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;

        try {
            const response = await fetch(`/user/${action}/${encodeURIComponent(username)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();
            if (response.ok && result.status === 'ok') {
                showNotification(action === 'accept' ? 'Заявка принята!' : 'Заявка отклонена');
                loadNotifications();
            } else {
                throw new Error(result.detail || `Ошибка при ${action === 'accept' ? 'принятии' : 'отклонении'} заявки`);
            }
        } catch (error) {
            showNotification(error.message, true);
        } finally {
            button.innerHTML = originalHtml;
            button.disabled = false;
        }
    }

    window.addEventListener('DOMContentLoaded', function() {
        formatBalances();
        if (balanceMenu) balanceMenu.style.display = 'none';
    });
</script>